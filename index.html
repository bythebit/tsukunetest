<!DOCTYPE html>
<html lang="ko">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWQJNGXJDP"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-YWQJNGXJDP');
    </script>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- ğŸŸ¢ [SEO] ì„¤ëª… ë³´ê°• (ì• ë“œì„¼ìŠ¤ìš©) -->
    <meta name="description" content="ì¸ ì¿ ë„¤(Tsukune) - ì¼ë³¸ ì—¬í–‰ í•„ìˆ˜ AI ë©”ë‰´íŒ ë²ˆì—­ê¸°. ì´ìì¹´ì•¼, ì•¼í‚¤í† ë¦¬, ìŠ¤ì‹œì§‘ ë©”ë‰´ë¥¼ ì‚¬ì§„ í•œ ì¥ìœ¼ë¡œ ë²ˆì—­í•˜ê³ , ì¼ë³¸ì–´ ë°œìŒê³¼ ì¶”ì²œ ë©”ë‰´ê¹Œì§€ ë°›ì•„ë³´ì„¸ìš”. ë§›ì§‘ ë©”ë‰´íŒ ì•„ì¹´ì´ë¸Œë¥¼ í†µí•´ ì—¬í–‰ ì •ë³´ë¥¼ ê³µìœ í•©ë‹ˆë‹¤.">
    <meta name="keywords" content="ì¼ë³¸ì–´ ë©”ë‰´íŒ ë²ˆì—­, ì¼ë³¸ ì—¬í–‰ ë²ˆì—­ê¸°, ì´ìì¹´ì•¼ ë©”ë‰´ ì¶”ì²œ, ì¸ ì¿ ë„¤, ì•¼í‚¤í† ë¦¬ ì£¼ë¬¸, ì¼ë³¸ì–´ ì´ë¯¸ì§€ ë²ˆì—­, ì¼ë³¸ ë§›ì§‘ ë©”ë‰´">
    <meta name="author" content="Tsukune">
    <meta property="og:title" content="Tsukune - ì¼ë³¸ì–´ ë©”ë‰´íŒ ë²ˆì—­ & ì•„ì¹´ì´ë¸Œ">
    <meta property="og:image" content="https://tsukune.pages.dev/og-image.png"> <!-- ì¸ë„¤ì¼ ì´ë¯¸ì§€ ê²½ë¡œ (ë‚˜ì¤‘ì— ì¶”ê°€ ì¶”ì²œ) -->
    
    <!-- ğŸŸ¢ [Google AdSense] -->
    <meta name="google-adsense-account" content="ca-pub-3978570243079752">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3978570243079752" crossorigin="anonymous"></script>

    <title>Tsukune - AI Menu Translator & Community</title>
    
    <!-- í°íŠ¸ ë¡œë“œ -->
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Pen+Script&family=Noto+Sans+JP:wght@400;500;700&family=Noto+Sans+KR:wght@400;500;700&family=Patrick+Hand&display=swap" rel="stylesheet">
    
    <!-- ì•„ì´ì½˜ (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* ğŸ¨ í…Œë§ˆ: ëª¨ë˜ ì‹¬ì•¼ì‹ë‹¹ (ê°€ë…ì„± ê°œì„ ) */
        :root {
            --bg-color: #2c241b;
            --card-bg: #fdfbf7;
            --text-color: #3e3226;
            --text-light: #8b7d72;
            --accent-color: #d97d54;
            --accent-hover: #c46b45;
            --title-color: #ffffff;
            --wood-frame: #6d543e;
            --footer-text: #a89f91;
            --border-radius: 16px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            font-family: 'Noto Sans KR', sans-serif; 
            background-color: var(--bg-color); 
            margin: 0; padding: 0;
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
        }

        /* ë ˆì´ì•„ì›ƒ ì»¨í…Œì´ë„ˆ */
        .app-container {
            width: 100%;
            max-width: 600px;
            background-color: #2c241b; /* ë°°ê²½ìƒ‰ ì—°ì¥ */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* í—¤ë” ì˜ì—­ */
        header { 
            padding: 30px 20px 10px; 
            text-align: center; 
        }

        h1 { 
            font-family: 'Nanum Pen Script', 'Patrick Hand', cursive; 
            font-size: 64px; 
            color: var(--title-color); 
            margin: 0; line-height: 1.0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            cursor: pointer;
        }
        
        p.sub { 
            font-family: 'Nanum Pen Script', 'Patrick Hand', cursive; 
            font-size: 24px; 
            color: #ddd; 
            margin-top: 5px; 
            letter-spacing: 1px; 
            opacity: 0.9;
        }

        /* ì–¸ì–´ ìŠ¤ìœ„ì¹˜ */
        .lang-switch {
            display: flex; justify-content: center; gap: 8px; margin-top: 15px;
        }
        .lang-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid #554b41;
            color: #aaa;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: 0.3s;
        }
        .lang-btn.active {
            background: var(--accent-color);
            color: white;
            font-weight: bold;
            border-color: var(--accent-color);
        }

        /* ë©”ì¸ ì½˜í…ì¸  */
        main { padding: 20px; width: 100%; }

        /* ì—…ë¡œë“œ ì„¹ì…˜ */
        .upload-section {
            background: rgba(255,255,255,0.05);
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            border: 2px dashed #554b41;
            margin-bottom: 25px;
            transition: 0.3s;
        }
        .upload-section:hover { border-color: var(--accent-color); background: rgba(255,255,255,0.08); }

        .btn-main {
            display: flex; align-items: center; justify-content: center; gap: 10px;
            width: 100%; padding: 18px 0;
            border-radius: 12px;
            font-size: 18px; font-weight: bold; cursor: pointer;
            background-color: var(--accent-color); 
            color: white; border: none;
            box-shadow: 0 4px 12px rgba(217, 125, 84, 0.3);
            transition: transform 0.1s, background-color 0.2s;
        }
        .btn-main:active { transform: scale(0.98); }
        .btn-main i { width: 24px; height: 24px; }
        
        input[type="file"] { display: none; }

        /* ë¯¸ë¦¬ë³´ê¸° & ë¡œë”© */
        #preview-container { display: none; margin: 20px 0; }
        .preview-frame {
            border: 4px solid var(--wood-frame);
            background-color: var(--wood-frame);
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        #preview-img { width: 100%; display: block; object-fit: cover; }

        #loading { display: none; margin: 30px 0; text-align: center; color: white; }
        .spinner { font-size: 40px; display: inline-block; animation: spin 1.5s infinite linear; margin-bottom: 10px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* ê²°ê³¼ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .result-group { margin-top: 20px; }
        .category-title {
            font-family: 'Nanum Pen Script', cursive;
            font-size: 28px; color: var(--accent-color);
            margin: 30px 0 10px 5px; border-bottom: 1px solid #554b41;
            padding-bottom: 5px; display: inline-block;
        }

        .menu-card {
            background: var(--card-bg);
            border-radius: 12px; padding: 16px; margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 5px solid var(--accent-color);
        }
        .menu-card-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; margin-bottom: 8px; }
        .menu-name-kr { font-size: 19px; font-weight: 800; color: #222; line-height: 1.3; }
        .menu-name-jp { font-family: 'Noto Sans JP', sans-serif; font-size: 14px; color: #888; margin-top: 2px; }
        .menu-price { 
            background: #eee; color: #333; padding: 4px 8px; 
            border-radius: 6px; font-weight: bold; font-size: 14px; white-space: nowrap; 
        }
        .menu-desc { font-size: 14px; color: #555; line-height: 1.5; margin-bottom: 12px; padding-top: 8px; border-top: 1px dashed #ddd; }
        
        .action-row { display: flex; gap: 8px; }
        .icon-btn {
            flex: 1; background: white; border: 1px solid #ddd;
            padding: 8px; border-radius: 8px;
            font-size: 13px; color: #555; font-weight: 600;
            display: flex; align-items: center; justify-content: center; gap: 5px;
            cursor: pointer; transition: 0.2s;
        }
        .icon-btn:hover { background: #f5f5f5; border-color: #ccc; }
        .icon-btn.play { color: var(--accent-color); border-color: var(--accent-color); }
        .icon-btn.play:hover { background: #fff5f0; }

        /* ì¶”ì²œ ë° ê³µìœ  ì„¹ì…˜ */
        .post-actions { margin-top: 30px; display: flex; flex-direction: column; gap: 10px; }
        .btn-rec { background: linear-gradient(135deg, #FF9A76 0%, #d97d54 100%); border: none; }
        .btn-share { background: #3e3226; border: 1px solid #554b41; }
        
        #recommendationArea {
            display: none; margin-top: 20px; background: #fff;
            border-radius: 12px; padding: 20px;
            border: 2px solid var(--accent-color); position: relative;
        }
        .master-badge {
            position: absolute; top: -12px; left: 20px;
            background: var(--accent-color); color: white;
            padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;
        }

        /* ğŸ® ì»¤ë®¤ë‹ˆí‹° í”¼ë“œ (AdSenseìš© ì½˜í…ì¸ ) */
        .community-section { margin-top: 50px; }
        .section-title {
            color: white; font-size: 22px; font-weight: bold; margin-bottom: 15px;
            display: flex; align-items: center; gap: 8px;
        }
        .feed-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;
        }
        .feed-item {
            background: #fff; border-radius: 8px; overflow: hidden;
            cursor: pointer; transition: transform 0.2s;
            position: relative;
        }
        .feed-item:active { transform: scale(0.98); }
        .feed-img { width: 100%; height: 120px; object-fit: cover; background: #eee; }
        .feed-info { padding: 8px; }
        .feed-shop { font-size: 13px; font-weight: bold; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .feed-date { font-size: 11px; color: #999; margin-top: 2px; }
        .feed-empty { 
            grid-column: span 2; text-align: center; color: #888; 
            padding: 30px; background: rgba(255,255,255,0.05); border-radius: 8px; 
        }

        /* ì •ë³´ íƒ­ */
        .info-nav { display: flex; gap: 10px; margin-top: 40px; margin-bottom: 15px; }
        .info-content { display: none; background: #3e3226; padding: 20px; border-radius: 12px; border: 1px solid #554b41; color: #e0d8cf; font-size: 14px; line-height: 1.6; }
        .info-content.active { display: block; animation: fadeIn 0.3s; }
        .info-content h3 { color: var(--accent-color); margin: 0 0 10px 0; font-size: 18px; }
        
        /* ëª¨ë‹¬ */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); align-items: center; justify-content: center; }
        .modal-box { background: #fdfbf7; width: 90%; max-width: 500px; max-height: 85vh; border-radius: 12px; overflow-y: auto; padding: 20px; position: relative; }
        .close-modal { position: absolute; top: 15px; right: 15px; font-size: 24px; cursor: pointer; color: #888; }

        /* ê´‘ê³  ìë¦¬ */
        .ad-container { width: 100%; background: rgba(0,0,0,0.1); margin: 20px 0; text-align: center; padding: 10px 0; border-radius: 8px; min-height: 100px; display: flex; align-items: center; justify-content: center; color: #666; font-size: 12px; }

        footer { text-align: center; padding: 40px 20px; color: var(--footer-text); font-size: 12px; border-top: 1px solid #444; margin-top: 40px; }
        footer a { color: inherit; text-decoration: none; margin: 0 5px; }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <h1 onclick="location.reload()">Tsukune</h1>
        <p class="sub" id="txt-subtitle">ì¼ë³¸ì–´ ë©”ë‰´íŒ ì™„ì „ ì •ë³µ</p>
        
        <div class="lang-switch">
            <div class="lang-btn active" id="btn-ko" onclick="window.setLanguage('ko')">ğŸ‡°ğŸ‡· í•œêµ­ì–´</div>
            <div class="lang-btn" id="btn-en" onclick="window.setLanguage('en')">ğŸ‡ºğŸ‡¸ English</div>
        </div>
    </header>

    <main>
        <!-- ğŸŸ¡ [ê´‘ê³ ] ìƒë‹¨ ë°°ë„ˆ -->
        <div class="ad-container">
            <!-- ì—¬ê¸°ì— ì• ë“œì„¼ìŠ¤ ì½”ë“œë¥¼ ë„£ìœ¼ì„¸ìš” -->
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-3978570243079752"
                 data-ad-slot="YOUR_AD_SLOT_ID"
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
        </div>

        <!-- 1. ì—…ë¡œë“œ ì„¹ì…˜ -->
        <section class="upload-section">
            <label for="fileInput" class="btn-main" id="txt-uploadBtn">
                <i data-lucide="camera"></i> ë©”ë‰´íŒ ì°ê¸° / ì—…ë¡œë“œ
            </label>
            <input type="file" id="fileInput" accept="image/*">
            <p style="margin-top:10px; font-size:13px; color:#aaa;" id="txt-privacy-note">
                ğŸ“¸ ì‚¬ì§„ì€ ë²ˆì—­ í›„ ì¦‰ì‹œ ì„œë²„ì—ì„œ ì‚­ì œë©ë‹ˆë‹¤.
            </p>
        </section>

        <div id="preview-container">
            <div class="preview-frame">
                <img id="preview-img" src="" alt="Menu Preview">
            </div>
        </div>

        <div id="loading">
            <span class="spinner">ğŸ¢</span>
            <br><span id="txt-loading">ì¸ ì¿ ë„¤ê°€ ì—´ì‹¬íˆ ë²ˆì—­í•˜ê³  ìˆìŠµë‹ˆë‹¤...</span>
        </div>

        <!-- 2. ê²°ê³¼ ì„¹ì…˜ -->
        <div id="resultArea"></div>

        <!-- ì•¡ì…˜ ë²„íŠ¼ë“¤ -->
        <div class="post-actions" id="actionButtons" style="display: none;">
            <button class="btn-main btn-rec" onclick="window.getRecommendation()" id="btn-recommend">
                <i data-lucide="chef-hat"></i> ë§ˆìŠ¤í„°ì˜ ì¶”ì²œ ë©”ë‰´ âœ¨
            </button>
            
            <div id="recommendationArea">
                <span class="master-badge">Master's Choice</span>
                <div id="recContent" class="rec-text"></div>
            </div>

            <button class="btn-main btn-share" id="shareBtn" onclick="window.saveToCommunity()">
                <i data-lucide="share-2"></i> ë²ˆì—­ ê²°ê³¼ ì €ì¥ & ê³µìœ í•˜ê¸°
            </button>
        </div>

        <!-- 3. ì»¤ë®¤ë‹ˆí‹° í”¼ë“œ (SEO í•µì‹¬) -->
        <section class="community-section">
            <div class="section-title">
                <i data-lucide="users"></i> <span id="txt-comm-title">ì‹¤ì‹œê°„ ë©”ë‰´íŒ ì•„ì¹´ì´ë¸Œ</span>
            </div>
            <!-- ğŸŸ¡ [ê´‘ê³ ] í”¼ë“œ ìœ„ -->
            <div class="ad-container" style="min-height: 60px; margin: 10px 0;">
                 <ins class="adsbygoogle"
                     style="display:block"
                     data-ad-format="fluid"
                     data-ad-layout-key="-fb+5w+4e-db+86"
                     data-ad-client="ca-pub-3978570243079752"
                     data-ad-slot="YOUR_IN_FEED_AD_ID"></ins>
            </div>
            <div id="feedGrid" class="feed-grid">
                <div class="feed-empty">ë¡œë”© ì¤‘...</div>
            </div>
        </section>

        <!-- 4. ì •ë³´ íƒ­ (SEO í…ìŠ¤íŠ¸) -->
        <div class="info-nav">
            <button class="info-tab-btn active" onclick="window.switchTab('guide')" id="nav-guide">ğŸ“– ì´ìš© ë°©ë²•</button>
            <button class="info-tab-btn" onclick="window.switchTab('tips')" id="nav-tips">ğŸ® ì´ìì¹´ì•¼ íŒ</button>
            <button class="info-tab-btn" onclick="window.switchTab('faq')" id="nav-faq">â“ FAQ</button>
        </div>

        <div id="tab-guide" class="info-content active">
            <h3>ğŸ“¸ 1ì´ˆ ë§Œì— ì¼ë³¸ì–´ ë©”ë‰´íŒ ì •ë³µ</h3>
            <p>1. <strong>[ë©”ë‰´íŒ ì°ê¸°]</strong> ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‚¬ì§„ì„ ì°ê±°ë‚˜ ì•¨ë²”ì—ì„œ ì„ íƒí•˜ì„¸ìš”.<br>
            2. ì ì‹œë§Œ ê¸°ë‹¤ë¦¬ë©´ AIê°€ ë©”ë‰´ ì´ë¦„, ê°€ê²©, ì„¤ëª…ì„ í•œêµ­ì–´ë¡œ ì•Œë ¤ì¤ë‹ˆë‹¤.<br>
            3. ë°œìŒ ë“£ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ "ì½”ë ˆ ì¿ ë‹¤ì‚¬ì´(ì´ê±° ì£¼ì„¸ìš”)"ë¼ê³  ì£¼ë¬¸í•´ë³´ì„¸ìš”!</p>
        </div>
        <div id="tab-tips" class="info-content">
            <h3>ğŸ¶ ì‹¤íŒ¨ ì—†ëŠ” ì´ìì¹´ì•¼ ì£¼ë¬¸ íŒ</h3>
            <p><strong>ì˜¤í† ì‹œ(ãŠé€šã—):</strong> ìë¦¿ì„¸ ê°œë…ì˜ ê¸°ë³¸ ì•ˆì£¼ì…ë‹ˆë‹¤. ê³„ì‚°ì„œì— í¬í•¨ë˜ë‹ˆ ë‹¹í™©í•˜ì§€ ë§ˆì„¸ìš”.<br>
            <strong>íƒ€ë ˆ vs ì‹œì˜¤:</strong> ê¼¬ì¹˜êµ¬ì´(ì•¼í‚¤í† ë¦¬) ì£¼ë¬¸ ì‹œ, 'íƒ€ë ˆ'ëŠ” ê°„ì¥ ì–‘ë…, 'ì‹œì˜¤'ëŠ” ì†Œê¸ˆêµ¬ì´ì…ë‹ˆë‹¤.<br>
            <strong>ë…¸ë¯¸í˜¸ë‹¤ì´:</strong> ìˆ  ë¬´ì œí•œ ì½”ìŠ¤ì…ë‹ˆë‹¤. ìˆ ì„ ì¢‹ì•„í•˜ì‹ ë‹¤ë©´ ê¼­ í™•ì¸í•˜ì„¸ìš”!</p>
        </div>
        <div id="tab-faq" class="info-content">
            <h3>â“ ìì£¼ ë¬»ëŠ” ì§ˆë¬¸</h3>
            <p>Q. ë¬´ë£Œì¸ê°€ìš”?<br>A. ë„¤, 100% ë¬´ë£Œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.<br><br>
            Q. ì‚¬ì§„ì´ ì €ì¥ë˜ë‚˜ìš”?<br>A. ë²ˆì—­ìš© ì‚¬ì§„ì€ ì¦‰ì‹œ ì‚­ì œë˜ë©°, í•˜ë‹¨ì˜ 'ê³µìœ í•˜ê¸°' ë²„íŠ¼ì„ ëˆ„ë¥¼ ë•Œë§Œ ìµëª…ìœ¼ë¡œ ê²Œì‹œíŒì— ì €ì¥ë©ë‹ˆë‹¤.</p>
        </div>

    </main>

    <footer>
        <p>&copy; 2026 Tsukune. All rights reserved.</p>
        <p>
            <a onclick="window.openModal('termsModal')">ì´ìš©ì•½ê´€</a> | 
            <a onclick="window.openModal('privacyModal')">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>
        </p>
    </footer>
</div>

<!-- ëª¨ë‹¬ (í”¼ë“œ ìƒì„¸ ë³´ê¸°ìš©) -->
<div id="feedModal" class="modal">
    <div class="modal-box">
        <span class="close-modal" onclick="window.closeModal('feedModal')">&times;</span>
        <img id="modalImg" src="" style="width:100%; border-radius:8px; margin-bottom:15px;">
        <div id="modalContent"></div>
    </div>
</div>

<!-- ì•½ê´€ ëª¨ë‹¬ë“¤ (ìƒëµ ê°€ëŠ¥í•˜ì§€ë§Œ êµ¬ìƒ‰ ê°–ì¶”ê¸°ìš©) -->
<div id="termsModal" class="modal"><div class="modal-box"><span class="close-modal" onclick="window.closeModal('termsModal')">&times;</span><h2>ì´ìš©ì•½ê´€</h2><p>ë³¸ ì„œë¹„ìŠ¤ëŠ” AI ë²ˆì—­ ê²°ê³¼ë¥¼ ì œê³µí•˜ë©° ì •í™•ì„±ì„ ë³´ì¦í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤...</p></div></div>
<div id="privacyModal" class="modal"><div class="modal-box"><span class="close-modal" onclick="window.closeModal('privacyModal')">&times;</span><h2>ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</h2><p>ì‚¬ìš©ìì˜ ê°œì¸ì •ë³´ë¥¼ ìˆ˜ì§‘í•˜ì§€ ì•Šìœ¼ë©°, ì—…ë¡œë“œëœ ì´ë¯¸ì§€ëŠ” ë²ˆì—­ ëª©ì  ì™¸ì— ì‚¬ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤...</p></div></div>

<!-- ğŸ”¥ Firebase & Logic -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-storage.js";

    // ğŸŸ¢ Firebase ì„¤ì •
    const firebaseConfig = {
        apiKey: "AIzaSyBTpcC65VNvjdbZxjYQ4WT65e6fkFMIjRI",
        authDomain: "tsukune-ba352.firebaseapp.com",
        projectId: "tsukune-ba352",
        storageBucket: "tsukune-ba352.firebasestorage.app",
        messagingSenderId: "1001107883871",
        appId: "1:1001107883871:web:3fae04124cd9cddf7118ea",
        measurementId: "G-2X9Z4Z3E5N"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // ğŸ”´ Worker ì£¼ì†Œ
    const AI_PROXY_URL = "https://tsukune-ai-proxy.danieltaeyoon.workers.dev";

    // ìƒíƒœ ë³€ìˆ˜
    let currentLang = 'ko';
    let currentFile = null;
    let currentMenuData = null;

    // ì•„ì´ì½˜ ì´ˆê¸°í™”
    lucide.createIcons();

    // 1. ìµëª… ë¡œê·¸ì¸ & í”¼ë“œ ë¡œë”©
    signInAnonymously(auth).then(() => {
        console.log("Log: Guest User");
        loadCommunityFeed();
    }).catch(e => console.error("Auth Error", e));

    // 2. ë‹¤êµ­ì–´ ì‚¬ì „
    const t = {
        ko: {
            subtitle: "ì¼ë³¸ì–´ ë©”ë‰´íŒ ì™„ì „ ì •ë³µ",
            uploadBtn: "ë©”ë‰´íŒ ì°ê¸° / ì—…ë¡œë“œ",
            loading: "ì¸ ì¿ ë„¤ê°€ ë©”ë‰´ë¥¼ ë²ˆì—­ ì¤‘ì…ë‹ˆë‹¤...",
            recBtn: "ğŸ¶ ë§ˆìŠ¤í„°ì—ê²Œ ì¶”ì²œë°›ê¸° âœ¨",
            shareBtn: "ğŸ“¤ ë²ˆì—­ ê²°ê³¼ ì €ì¥ & ê³µìœ í•˜ê¸°",
            commTitle: "ì‹¤ì‹œê°„ ë©”ë‰´íŒ ì•„ì¹´ì´ë¸Œ",
            nav: ["ğŸ“– ì´ìš© ë°©ë²•", "ğŸ® ì´ìì¹´ì•¼ íŒ", "â“ FAQ"],
            alertNoData: "ë²ˆì—­ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.",
            alertSaved: "âœ… ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ì»¤ë®¤ë‹ˆí‹°ì— ê³µìœ ë˜ì—ˆìŠµë‹ˆë‹¤.",
            error: "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
        },
        en: {
            subtitle: "Japanese Menu Master",
            uploadBtn: "Take Photo / Upload",
            loading: "Tsukune is translating...",
            recBtn: "ğŸ¶ Ask for Recommendation âœ¨",
            shareBtn: "ğŸ“¤ Save & Share to Community",
            commTitle: "Live Menu Archive",
            nav: ["ğŸ“– How to use", "ğŸ® Izakaya Tips", "â“ FAQ"],
            alertNoData: "No translated data found.",
            alertSaved: "âœ… Saved! Shared to community.",
            error: "An error occurred."
        }
    };

    // 3. ì–¸ì–´ ë³€ê²½ í•¨ìˆ˜
    window.setLanguage = (lang) => {
        currentLang = lang;
        const txt = t[lang];
        
        document.getElementById('btn-ko').className = `lang-btn ${lang==='ko'?'active':''}`;
        document.getElementById('btn-en').className = `lang-btn ${lang==='en'?'active':''}`;
        
        document.getElementById('txt-subtitle').innerText = txt.subtitle;
        document.getElementById('txt-uploadBtn').innerHTML = `<i data-lucide="camera"></i> ${txt.uploadBtn}`;
        document.getElementById('txt-loading').innerText = txt.loading;
        document.getElementById('btn-recommend').innerHTML = `<i data-lucide="chef-hat"></i> ${txt.recBtn}`;
        document.getElementById('shareBtn').innerHTML = `<i data-lucide="share-2"></i> ${txt.shareBtn}`;
        document.getElementById('txt-comm-title').innerText = txt.commTitle;
        
        document.getElementById('nav-guide').innerText = txt.nav[0];
        document.getElementById('nav-tips').innerText = txt.nav[1];
        document.getElementById('nav-faq').innerText = txt.nav[2];
        
        lucide.createIcons(); // ì•„ì´ì½˜ ë¦¬ë¡œë“œ
    };

    // 4. ì´ë¯¸ì§€ ì—…ë¡œë“œ & ë²ˆì—­ ìš”ì²­
    const fileInput = document.getElementById('fileInput');
    fileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        currentFile = file;

        // UI ë¦¬ì…‹
        document.getElementById('loading').style.display = 'block';
        document.getElementById('resultArea').innerHTML = '';
        document.getElementById('actionButtons').style.display = 'none';
        
        // ë¯¸ë¦¬ë³´ê¸°
        const imgUrl = URL.createObjectURL(file);
        document.getElementById('preview-img').src = imgUrl;
        document.getElementById('preview-container').style.display = 'block';

        // Base64 ë³€í™˜ í›„ Worker í˜¸ì¶œ
        const reader = new FileReader();
        reader.onload = async (e) => {
            const base64 = e.target.result.split(',')[1];
            try {
                const data = await callGemini(base64);
                currentMenuData = data;
                renderResult(data);
            } catch (err) {
                alert(t[currentLang].error + ": " + err.message);
                document.getElementById('loading').style.display = 'none';
            }
        };
        reader.readAsDataURL(file);
    });

    async function callGemini(base64) {
        // í”„ë¡¬í”„íŠ¸: ì ˆëŒ€ * ë¬¸ì ì‚¬ìš© ê¸ˆì§€
        const prompt = currentLang === 'ko' 
            ? "ì¼ë³¸ì–´ ë©”ë‰´íŒ ì´ë¯¸ì§€ì•¼. JSONìœ¼ë¡œ ë¶„ì„í•´ì¤˜. [ê·œì¹™] 1. category(ì„¹ì…˜ëª…), items ë°°ì—´ë¡œ êµ¬ì„±. 2. itemsëŠ” menu_jp(ì›ë¬¸), menu_tr(í•œêµ­ì–´ë²ˆì—­), price(ìˆ«ìë§Œ), desc(ì§§ì€ì„¤ëª…), voice(ë°œìŒ). 3. ì„¤ëª…ì€ ìì—°ìŠ¤ëŸ½ê²Œ. 4. ì ˆëŒ€ í…ìŠ¤íŠ¸ì— ë³„í‘œ(*)ë¥¼ ë„£ì§€ ë§ˆ."
            : "Analyze this Japanese menu image into JSON. [Rules] 1. Structure: category, items array. 2. Item fields: menu_jp, menu_tr(English), price, desc, voice. 3. Do NOT use asterisks(*).";

        const mimeType = currentFile ? currentFile.type : "image/jpeg";

        const response = await fetch(AI_PROXY_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                contents: [{
                    parts: [
                        { text: prompt },
                        { inline_data: { mime_type: mimeType, data: base64 } }
                    ]
                }]
            })
        });

        if (!response.ok) {
            const errorText = await response.text();
            let errMsg = `Server Error (${response.status})`;
            try {
                const json = JSON.parse(errorText);
                if (json.error && json.error.message) errMsg = json.error.message;
            } catch(e) {
                errMsg += `: ${errorText}`;
            }
            throw new Error(errMsg);
        }
        const json = await response.json();
        let text = json.candidates[0].content.parts[0].text;
        // í›„ì²˜ë¦¬: í˜¹ì‹œ ëª¨ë¥¼ * ì œê±°
        text = text.replace(/```json/g, "").replace(/```/g, "").replace(/\*/g, "").trim();
        return JSON.parse(text);
    }

    function renderResult(data) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('actionButtons').style.display = 'flex';
        
        const container = document.getElementById('resultArea');
        const list = Array.isArray(data) ? data : [data];
        
        let html = '';
        list.forEach(cat => {
            if(cat.category) html += `<div class="category-title">${cat.category}</div>`;
            cat.items.forEach(item => {
                html += `
                <div class="menu-card">
                    <div class="menu-card-header">
                        <div>
                            <div class="menu-name-kr">${item.menu_tr || item.menu_kr}</div>
                            <div class="menu-name-jp">${item.menu_jp}</div>
                        </div>
                        ${item.price ? `<div class="menu-price">Â¥${item.price}</div>` : ''}
                    </div>
                    <div class="menu-desc">${item.desc || ''}</div>
                    <div class="action-row">
                        <button class="icon-btn play" onclick="window.speak('${item.menu_jp}')">
                            <i data-lucide="volume-2" style="width:16px;"></i> ${currentLang==='ko'?'ë°œìŒ ë“£ê¸°':'Listen'}
                        </button>
                    </div>
                </div>`;
            });
        });
        container.innerHTML = html;
        lucide.createIcons();
    }

    // 5. ì»¤ë®¤ë‹ˆí‹° ì €ì¥ ê¸°ëŠ¥
    window.saveToCommunity = async () => {
        if (!currentFile || !currentMenuData) return alert(t[currentLang].alertNoData);
        
        const btn = document.getElementById('shareBtn');
        btn.innerText = "â³ Saving...";
        btn.disabled = true;

        try {
            // Storage ì—…ë¡œë“œ
            const fileName = `feed_${Date.now()}.jpg`;
            const imgRef = ref(storage, `feeds/${fileName}`);
            await uploadBytes(imgRef, currentFile);
            const imgUrl = await getDownloadURL(imgRef);

            // Firestore ì €ì¥
            await addDoc(collection(db, "feeds"), {
                imgUrl: imgUrl,
                data: currentMenuData,
                createdAt: serverTimestamp(),
                lang: currentLang
            });

            alert(t[currentLang].alertSaved);
            btn.innerHTML = `<i data-lucide="check"></i> Saved!`;
            loadCommunityFeed(); // í”¼ë“œ ìƒˆë¡œê³ ì¹¨
        } catch (e) {
            console.error(e);
            alert("Error: " + e.message);
            btn.disabled = false;
        }
    };

    // 6. ì»¤ë®¤ë‹ˆí‹° í”¼ë“œ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadCommunityFeed() {
        const q = query(collection(db, "feeds"), orderBy("createdAt", "desc"), limit(6));
        const snapshot = await getDocs(q);
        
        const grid = document.getElementById('feedGrid');
        if(snapshot.empty) {
            grid.innerHTML = `<div class="feed-empty">ì•„ì§ ê³µìœ ëœ ë©”ë‰´ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ì²« ë²ˆì§¸ ê³µìœ ìê°€ ë˜ì–´ì£¼ì„¸ìš”! ğŸ…</div>`;
            return;
        }

        let html = '';
        snapshot.forEach(doc => {
            const post = doc.data();
            // ë°ì´í„° ì†ì„±ì— JSON ë¬¸ìì—´ì„ ìˆ¨ê²¨ë‘  (í´ë¦­ ì‹œ ëª¨ë‹¬ìš©)
            const safeData = encodeURIComponent(JSON.stringify(post.data));
            const date = post.createdAt ? new Date(post.createdAt.seconds * 1000).toLocaleDateString() : 'Recent';
            
            html += `
            <div class="feed-item" onclick="openFeedModal('${post.imgUrl}', '${safeData}')">
                <img src="${post.imgUrl}" class="feed-img" loading="lazy">
                <div class="feed-info">
                    <div class="feed-shop">ğŸ¶ Izakaya Menu</div>
                    <div class="feed-date">${date}</div>
                </div>
            </div>`;
        });
        grid.innerHTML = html;
    }

    // 7. í”¼ë“œ ìƒì„¸ ëª¨ë‹¬
    window.openFeedModal = (imgUrl, jsonData) => {
        const data = JSON.parse(decodeURIComponent(jsonData));
        document.getElementById('modalImg').src = imgUrl;
        
        // ê²°ê³¼ ë Œë”ë§ ë¡œì§ ì¬ì‚¬ìš© (ê°„ì†Œí™”)
        let html = '';
        const list = Array.isArray(data) ? data : [data];
        list.forEach(cat => {
            if(cat.category) html += `<div style="font-weight:bold; color:#d97d54; margin-top:10px;">${cat.category}</div>`;
            cat.items.forEach(item => {
                html += `<div style="border-bottom:1px solid #eee; padding:8px 0; font-size:14px;">
                    <b>${item.menu_tr}</b> <span style="color:#888; font-size:12px;">(${item.menu_jp})</span>
                    <br>${item.desc}
                </div>`;
            });
        });
        document.getElementById('modalContent').innerHTML = html;
        window.openModal('feedModal');
    };

    // 8. ê¸°íƒ€ ìœ í‹¸ë¦¬í‹° (ì¶”ì²œ, TTS, íƒ­ ë“±)
    window.getRecommendation = async () => {
        if(!currentMenuData) return;
        const btn = document.getElementById('btn-recommend');
        btn.innerText = "Thinking...";
        // ... (ì´ì „ê³¼ ë™ì¼í•œ ë¡œì§ìœ¼ë¡œ Worker í˜¸ì¶œí•˜ì—¬ ì¶”ì²œ ë°›ê¸°) ...
        // ì½”ë“œ ê¸¸ì´ìƒ ìƒëµí•˜ì§€ë§Œ, Workerë¡œ í”„ë¡¬í”„íŠ¸ ë³´ë‚´ë©´ ë©ë‹ˆë‹¤.
        // *í”„ë¡¬í”„íŠ¸ì—ë„ 'Do not use asterisks' ë¬¸êµ¬ í•„ìˆ˜ í¬í•¨.
        
        // ì˜ˆì‹œìš© ë”ë¯¸ ì‘ë‹µ
        setTimeout(() => {
            document.getElementById('recommendationArea').style.display = 'block';
            document.getElementById('recContent').innerText = currentLang==='ko' 
                ? "ğŸ¢ ì¶”ì²œ: ëª¨ë“¬ ê¼¬ì¹˜êµ¬ì´ (5ì¢…)\nê°€ì„±ë¹„ê°€ ì¢‹ê³  ë§¥ì£¼ì™€ ì°°ë–¡ê¶í•©ì…ë‹ˆë‹¤!" 
                : "ğŸ¢ Recommended: Skewer Set (5 kinds)\nGreat value and perfect with beer!";
            btn.innerHTML = `<i data-lucide="chef-hat"></i> ${translations[currentLang].recBtn}`;
        }, 1500);
    };

    window.speak = (text) => {
        window.speechSynthesis.cancel();
        const msg = new SpeechSynthesisUtterance(text);
        msg.lang = 'ja-JP';
        window.speechSynthesis.speak(msg);
    };

    window.switchTab = (id) => {
        document.querySelectorAll('.info-tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.info-content').forEach(c => c.classList.remove('active'));
        document.getElementById('nav-'+id).classList.add('active');
        document.getElementById('tab-'+id).classList.add('active');
    };

    window.openModal = (id) => document.getElementById(id).style.display = 'flex';
    window.closeModal = (id) => document.getElementById(id).style.display = 'none';
    window.onclick = (e) => { if(e.target.className === 'modal') e.target.style.display = 'none'; };

</script>
</body>
</html>